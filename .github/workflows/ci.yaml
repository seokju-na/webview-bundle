name: ci
on:
  pull_request:
concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true
env:
  LEFTHOOK: 0
jobs:
  format:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          components: rustfmt
      - name: Setup Node.js
        uses: ./.github/actions/node-setup
      - run: yarn install --immutable
      - name: Run rustfmt
        run: cargo fmt --all --check
      - name: Run taplo
        run: yarn taplo format --check
      - name: Run oxfmt
        run: yarn oxfmt --check
  test:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    name: test (${{ matrix.settings.host }}, ${{ matrix.settings.target }})
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-15-intel
            target: x86_64-apple-darwin
            build: |
              yarn workspaces foreach -At run build-napi --target x86_64-apple-darwin
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: macos-latest
            target: aarch64-apple-darwin
            build: |
              yarn workspaces foreach -At run build-napi --target aarch64-apple-darwin
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: windows-latest
            target: i686-pc-windows-msvc
            build: |
              yarn workspaces foreach -At run build-napi --target i686-pc-windows-msvc
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            build: |
              yarn workspaces foreach -At run build-napi --target x86_64-pc-windows-msvc
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: windows-latest
            target: aarch64-pc-windows-msvc
            build: |
              yarn workspaces foreach -At run build-napi --target aarch64-pc-windows-msvc
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build: |
              yarn workspaces foreach -At run build-napi --target x86_64-unknown-linux-gnu --use-napi-cross
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: |
              yarn workspaces foreach -At run build-napi --target x86_64-unknown-linux-musl -x
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            build: |
              yarn workspaces foreach -At run build-napi --target aarch64-unknown-linux-gnu --use-napi-cross
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: aarch64-unknown-linux-musl
            build: |
              yarn workspaces foreach -At run build-napi --target aarch64-unknown-linux-musl -x
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            build: |
              yarn workspaces foreach -At run build-napi --target armv7-unknown-linux-gnueabihf --use-napi-cross
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: aarch64-linux-android
            build: |
              yarn workspaces foreach -At run build-napi --target aarch64-linux-android
              yarn workspaces foreach -Apt --include='@wvb/*' run build
          - host: ubuntu-latest
            target: armv7-linux-androideabi
            build: |
              yarn workspaces foreach -At run build-napi --target armv7-linux-androideabi
              yarn workspaces foreach -Apt --include='@wvb/*' run build
    runs-on: ${{ matrix.settings.host }}
    env:
      DEBUG: 'napi:*'
      MACOSX_DEPLOYMENT_TARGET: '10.13'
      CARGO_INCREMENTAL: '1'
      # Fix for ring crate cross-compilation on aarch64
      # See: https://github.com/briansmith/ring/issues/1789
      CFLAGS_aarch64_unknown_linux_gnu: ${{ matrix.settings.target == 'aarch64-unknown-linux-gnu' && '-D__ARM_ARCH=8' || '' }}
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup Node.js
        uses: ./.github/actions/node-setup
      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          targets: ${{ matrix.settings.target }}
          cache-key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}
      - uses: mlugg/setup-zig@d1434d08867e3ee9daa34448df10607b98908d29 # 2.2.1
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          version: 0.14.1
      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@288875dd3d64326724fa6d9593062d9f8ba0b131 # 2.67.30
        if: ${{ contains(matrix.settings.target, 'musl') }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild
      - run: yarn install --immutable
      - name: Run build
        run: ${{ matrix.settings.build }}
        shell: bash
      - name: Run vitest
        run: yarn vitest run
        shell: bash
  lint-rust:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup tauri for linux
        uses: ./.github/actions/tauri-linux-setup
      - name: Setup Rust
        uses: ./.github/actions/rust-setup
        with:
          components: clippy
      - name: Run clippy
        run: cargo clippy
  test-rust:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-15-intel
            target: x86_64-apple-darwin
          - host: macos-latest
            target: aarch64-apple-darwin
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - host: windows-latest
            target: x86_64-pc-windows-msvc
          - host: windows-latest
            target: aarch64-pc-windows-msvc
    runs-on: ${{ matrix.settings.host }}
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup tauri for linux
        if: ${{ matrix.settings.host == 'ubuntu-latest' }}
        uses: ./.github/actions/tauri-linux-setup
      - name: Setup Rust
        uses: ./.github/actions/rust-setup
      - name: Run cargo test
        run: cargo test --workspace --no-fail-fast --all-features
  typecheck-lint:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup tauri for linux
        uses: ./.github/actions/tauri-linux-setup
      - name: Setup Node.js
        uses: ./.github/actions/node-setup
      - name: Setup Rust
        uses: ./.github/actions/rust-setup
      - uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # 3.0.0
      - run: yarn install --immutable
      - name: Run build
        run: just build
      - name: Run oxlint
        run: yarn oxlint --type-aware
      - name: Run typecheck
        run: yarn workspaces foreach -Apt run typecheck
  attw:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Git checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
      - name: Setup Node.js
        uses: ./.github/actions/node-setup
      - run: yarn install --immutable
      - uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # 3.0.0
      - name: Run attw
        run: just xtask attw --include='packages/*' --exclude='**/npm/*'
